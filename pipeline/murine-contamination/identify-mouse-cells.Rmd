---
title: "Identify mouse cells across samples"
author: "Kieran R Campbell"
output:
  html_document
params:
  human_mouse_dir: 'data/human-mouse-sces/filtered_temperature_rdata_v3'
  human_mouse_prop_file: 'output.csv'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      cache = FALSE)

suppressPackageStartupMessages({
  library(scater)
  library(DropletUtils)
  library(SingleCellExperiment)
  library(dplyr)
  library(tidyverse)
  library(here)
  library(ggridges)
})

filter <- dplyr::filter
mutate <- dplyr::mutate
```

```{r}
sces_filenames <- dir(params$human_mouse_dir)

mouse_names <- sces_filenames[grep("^mouse", sces_filenames)] 

mouse_ids <- mouse_names %>% 
  gsub("mouse_", "", .) %>% 
  gsub(".rdata", "", ., fixed = TRUE)

human_names <- sces_filenames[grep("^human", sces_filenames)] 

human_ids <- human_names %>% 
  gsub("human_", "", .) %>% 
  gsub(".rdata", "", ., fixed = TRUE)

intersect_ids <- intersect(human_ids, mouse_ids)

setdiff(intersect_ids, mouse_ids)
setdiff(intersect_ids, human_ids)
```



```{r}
sces_human <- lapply(human_names, function(x) readRDS(file.path(params$human_mouse_dir, x)))
sces_mouse <- lapply(mouse_names, function(x) readRDS(file.path(params$human_mouse_dir, x)))


names(sces_human) <- human_ids
names(sces_mouse) <- mouse_ids
```


```{r}
extract_metric <- function(id, sce_list, organism) {
  sce <- sce_list[[id]]
  sce <- calculateQCMetrics(sce)
  dplyr::select(as.data.frame(colData(sce)), Barcode, total_counts) %>% 
    dplyr::mutate(sample_id = id, human_mouse = organism) %>% 
    as_tibble()
}

common_ids <- intersect(human_ids, mouse_ids)
df_human <- lapply(common_ids, extract_metric, sces_human, "human") %>% 
  bind_rows()
df_mouse <- lapply(common_ids, extract_metric, sces_mouse, "mouse") %>% 
  bind_rows()
```


```{r}
dfs <- inner_join(df_human, df_mouse, by = c("Barcode", "sample_id"), suffix = c("_human", "_mouse"))
```




```{r}
dfs <- replace_na(dfs, list(human = 0, mouse = 0)) %>% 
  dplyr::mutate(human_mouse_ratio = total_counts_human / total_counts_mouse,
                sum = total_counts_human + total_counts_mouse, 
                diff = total_counts_human - total_counts_mouse,
                diff_to_sum = diff / sum)
```

Let's add some annotation

```{r}
dfs <- mutate(dfs,
              sample_type = case_when(
                grepl("VOA|PBC", sample_id) ~ "Primary tumour",
                grepl("SA928", sample_id) ~ "Cell line",
                grepl("SA854", sample_id) ~ "Cell line",
                grepl("_SA[5-9]", sample_id) ~ "PDX"
              ))
```

```{r}
dfs <- mutate(dfs,
              is_mouse = diff_to_sum < 0)
```



```{r fig.height = 8, fig.width = 5}
filter(dfs, sum > 0) %>% 
  mutate(sample_id = forcats::fct_reorder(sample_id, diff_to_sum)) %>% 
  ggplot(aes(y = sample_id, x = diff_to_sum, group = sample_id)) + 
  geom_density_ridges(stat = 'binline', scale = 5, bins = 40, rel_min_height = 0.0005) +
  labs(x = "(human counts - mouse counts) / (human counts + mouse counts)", y = "Sample") +
  facet_grid(sample_type ~ ., scales = "free_y", space = "free_y") +
  theme_bw(base_size = 9) +
  theme(axis.title.x = element_text(size = 8))

ggsave(here("figs", "murine-contamination", "human_mouse_boxplot.png"), width = 5, height = 8)
```


```{r}
filter(dfs, sample_type == "PDX") %>% 
  ggplot(aes(x = diff_to_sum)) + 
  geom_histogram() +
  labs(x = "(human counts - mouse counts) / (human counts + mouse counts)", y = "# cells") +
  facet_wrap(~ sample_id, scales = "free_y", ncol = 4) +
  theme_bw(base_size = 8)

ggsave(here("figs", "murine-contamination", "human_mouse_histogram_pdxonly.png"), width = 8, height = 5)
```


```{r, fig.height = 10, fig.width = 6}
group_by(dfs, sample_id) %>% 
  dplyr::summarise(pct_mouse = 100 * mean(diff_to_sum < 0, na.rm=TRUE)) %>% 
  ggplot(aes(x = forcats::fct_reorder(sample_id, pct_mouse), y = pct_mouse)) +
  geom_bar(stat = 'identity') +
  coord_flip() +
  labs(y = "% of cells mouse", x = "Sample") +
  theme_bw(base_size = 10)

ggsave(here("figs", "murine-contamination", "pct_cells_mouse.png"), width = 5, height = 8)
```

```{r}
write_csv(dfs, params$human_mouse_prop_file)
```


